@model ChatRobor.Models.ApplicationUser
@using ChatRobor.Models

@{
    ViewData["Title"] = "User Settings";
    var preference = (UserPreference)ViewBag.Preference;
}

<div class="settings-container">
    <div class="settings-sidebar">
        <h2>Settings</h2>
        <ul class="settings-menu">
            <li><a href="#profile" onclick="switchTab('profile')" class="active">Profile</a></li>
            <li><a href="#preferences" onclick="switchTab('preferences')">Preferences</a></li>
            <li><a href="#security" onclick="switchTab('security')">Security</a></li>
        </ul>
    </div>

    <div class="settings-main">
        <!-- Profile Tab -->
        <div id="profile" class="tab-content active">
            <h3>Profile Settings</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label>Email (Read-only)</label>
                    <input type="text" value="@Model.Email" readonly class="form-control">
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="fullName" value="@Model.FullName" class="form-control">
                </div>

                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phoneNumber" value="@Model.PhoneNumber" class="form-control">
                </div>

                <button type="button" onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
            </form>
        </div>

        <!-- Preferences Tab -->
        <div id="preferences" class="tab-content">
            <h3>Chat Preferences</h3>
            <form id="preferencesForm">
                <div class="form-group">
                    <label>AI Model</label>
                    <select id="model" class="form-control">
                        <option value="deepseek-chat" @(preference.Model == "deepseek-chat" ? "selected" : "")>DeepSeek Chat</option>
                        <option value="deepseek-coder" @(preference.Model == "deepseek-coder" ? "selected" : "")>DeepSeek Coder</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Temperature (0.0 - 2.0)</label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="@preference.Temperature" class="form-range">
                    <span id="tempValue">@preference.Temperature</span>
                </div>

                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="maxTokens" value="@preference.MaxTokens" class="form-control">
                </div>

                <div class="form-group checkbox">
                    <label>
                        <input type="checkbox" id="showTimestamp" @(preference.ShowTimestamp ? "checked" : "")> Show message timestamps
                    </label>
                </div>

                <div class="form-group checkbox">
                    <label>
                        <input type="checkbox" id="enableNotifications" @(preference.EnableNotifications ? "checked" : "")> Enable notifications
                    </label>
                </div>

                <button type="button" onclick="updatePreferences()" class="btn btn-primary">Save Preferences</button>
            </form>
        </div>

        <!-- Security Tab -->
        <div id="security" class="tab-content">
            <h3>Security Settings</h3>
            <form id="securityForm">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-control">
                </div>

                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-control">
                </div>

                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-control">
                </div>

                <button type="button" onclick="changePassword()" class="btn btn-primary">Change Password</button>
            </form>

            <hr style="margin: 30px 0;">

            <h3>Account</h3>
            <p>Account created on: @Model.CreatedAt.ToString("yyyy-MM-dd")</p>
            <p>Last login: @Model.LastLogin.ToString("yyyy-MM-dd HH:mm")</p>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.settings-menu a').forEach(link => link.classList.remove('active'));

        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function updateProfile() {
        const formData = new URLSearchParams({
            'FullName': document.getElementById('fullName').value,
            'PhoneNumber': document.getElementById('phoneNumber').value
        });

        try {
            const response = await fetch('@Url.Action("UpdateProfile", "Settings")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + (data.errors?.join(', ') || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function updatePreferences() {
        const formData = new URLSearchParams({
            'Model': document.getElementById('model').value,
            'Temperature': parseFloat(document.getElementById('temperature').value),
            'MaxTokens': parseInt(document.getElementById('maxTokens').value),
            'ShowTimestamp': document.getElementById('showTimestamp').checked,
            'EnableNotifications': document.getElementById('enableNotifications').checked
        });

        try {
            const response = await fetch('@Url.Action("UpdatePreferences", "Settings")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function changePassword() {
        const current = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (newPass !== confirm) {
            alert('New passwords do not match');
            return;
        }

        const formData = new URLSearchParams({
            'currentPassword': current,
            'newPassword': newPass
        });

        try {
            const response = await fetch('@Url.Action("ChangePassword", "Settings")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                alert(data.message);
                document.getElementById('securityForm').reset();
            } else {
                alert('Error: ' + (data.errors?.join(', ') || data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Update temperature display
    document.getElementById('temperature')?.addEventListener('input', function() {
        document.getElementById('tempValue').textContent = this.value;
    });
</script>

<style>
    .settings-container {
        display: flex;
        max-width: 1000px;
        margin: 0 auto;
        gap: 30px;
        padding: 30px 20px;
    }

    .settings-sidebar {
        width: 200px;
    }

    .settings-sidebar h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
    }

    .settings-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .settings-menu li {
        margin-bottom: 10px;
    }

    .settings-menu a {
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        color: #333;
        border-radius: 5px;
        transition: all 0.2s;
    }

    .settings-menu a:hover,
    .settings-menu a.active {
        background-color: #667eea;
        color: white;
    }

    .settings-main {
        flex: 1;
        background: white;
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #eee;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }

    .form-control,
    .form-range {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-control:focus,
    .form-range:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-range {
        padding: 0;
    }

    .form-group.checkbox label {
        display: flex;
        align-items: center;
        font-weight: normal;
    }

    .form-group.checkbox input {
        margin-right: 10px;
        width: auto;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background-color: #5568d3;
    }

    hr {
        border: none;
        border-top: 1px solid #eee;
    }
</style>
